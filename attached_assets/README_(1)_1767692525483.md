# Loretta Health - Risk-to-Insights (RDP001)

**Predicting Diabetes from NHANES 2021-2023**

---

## Overview

This repository contains every resource needed to reproduce the Loretta Health *Riskd-tod-Insights* showcase (**RDP001**). The objective is to build, evaluate and deploy a robust machined-learning model that predicts the probability of diabetes for an individual using the latest CDC NHANES survey data.

## Development 

### Setting up the local environment

The recommended workflow is based on Anaconda (Python 3.11). 
The following section explains based off of the Anaconda. 
However, feel free to use venv+pip if preferred. Ensure Python=3.11.

0. Install [Anaconda](https://www.anaconda.com/docs/getting-started/anaconda/install#macos-linux-installation) and open the anaconda terminal (optional but highly recommended)

1. Clone the repository

```bash
$ git clone git@github.com:Loretta-Health/rdp001_risk_to_insight_showcases.git
$ cd rdp001_risk_to_insight_showcases
```

2. Create & activate the conda environment

```bash
$ conda create -n rdp001 python=3.11
$ conda activate rdp001
```

3. Install project dependencies

```bash
$ pip install -r requirements.txt
```

### Running bash scripts

The `scripts/` directory contains helper shell scripts that let you execute individual stages of the pipeline without touching code directly:

| Script | Purpose |
|--------|---------|
| `convert_xpt.sh` | Convert NHANES `.XPT` files and to CSV for use |
| `prepare_data.sh` | Preparation of datasets |
| `run_boruta.sh` | Perform Boruta featured-selection and save the ranked feature list |
| `final_selection.sh` | Consolidate Boruta results into the final feature list used in production |
| `generate_patient.sh` | Select patient with "interesting factor" and save its id, probability, features, values, and SHAP values |
| `train_model.sh` | Train the XGBoost model with tuned hyper-parameters |
| `evaluate_model.sh` | Evaluate the trained model on the hold-out set and generate a report |
| `rdp001.sh`| Will run everything (from top to end of a pipeline) **Not recommended unless running for the first time or you are confident to do so** 

## Add/Remove Features from Training Set

Currently, ~100 features are used for Boruta feature selection. To add or remove features, follow the steps below:

### 1. Locate the CSV File
Identify the CSV file that contains the feature you want to modify (e.g., `demographics/csv/DEMO_L.csv`).  
If the file does not exist, you'll need to create it — see the "Creating a New CSV File" section below.

### 2. Open the Feature Configuration
Open `data/feature_config.json`.

### 3. Modify the Configuration
Find the JSON key that matches the CSV file (e.g., `"DEMO_L.csv"`).  
If it doesn't exist, add it — but make sure the corresponding CSV file actually exists.

- **To remove a feature:** Simply delete the corresponding entry.
- **To add a feature:** Define the following fields:
  - `feature_id`: Column name in the CSV.
  - `feature_desc`: Human-readable description.
  - `value_type`: Either `"Categorical"` or `"Numerical"`.
  - `recode_dict`: (Only for categorical features) A mapping of original values to recoded values.  
    For example, NHANES often codes `Yes = 1` and `No = 2`, which may need to be changed for consistency with ML standards.
  - `age_filter`: Specify the applicable age range if needed.

If you're unsure how to format these fields, refer to how existing features are defined in the config.

### 4. Run Boruta Feature Selection
Execute the following command to re-run feature extraction and Boruta ranking:

```bash
bash ./scripts/run_boruta.sh
``` 

### Creating a New CSV File

1. [Download](https://wwwn.cdc.gov/nchs/nhanes/continuousnhanes/default.aspx?Cycle=2021-2023) the `.xpt` file containing the feature of interest from the NHANES website.

2. Place the `.xpt` file in the appropriate folder under `data/<category>/xpt/`.  
   For example: `data/demographics/xpt/`.

   > If the category folder doesn't exist yet (e.g., `laboratory`), create it manually.

3. Convert the `.xpt` file into a `.csv` by running:

```bash
bash ./scripts/convert_xpt.sh
```

This will generate the CSV file that can then be referenced in `feature_config.json`.

## Project Structure

| Path          | Purpose                                                                    |
|---------------|----------------------------------------------------------------------------|
| `analysis/`   | Files for exploratory data analysis                                        |
| `code_books/` | NHANES data dictionaries and variable metadata                             |
| `data/`       | Raw downloads and intermediate, cleaned data artifacts                     |
| `doc/`        | Documentation related resources                                            |
| `example/`    | Example script which allows to play around the model with test subjects    |
| `model/`      | Training configuration, model checkpoints, and exported artifacts          |
| `scripts/`    | Bash helpers that orchestrate each stage of the pipeline                   |
| `test/`       | Unit and integration tests (pytest)                                        |
| `utils/`      | Reusable Python utilities shared across the codebase                       |

## Development Pipeline

![](./doc/pipeline_diagram_combined.png)

## Data Source

We rely on the CDC's National Health and Nutrition Examination Survey (**NHANES**) 2021d-2023 cycle. The public datasets can be downloaded from the [CDC portal](https://wwwn.cdc.gov/nchs/nhanes/continuousnhanes/default.aspx?Cycle=2021-2023).

NHANES provides six major data categories:

| Category | Typical contents |
|----------|------------------|
| Demographics | Age, gender, social-economic status |
| Dietary | 24d-hour dietary recalls |
| Examination | Physical measurements |
| Laboratory | Blood & urine analytics |
| Questionnaire | Self-reported health behaviors |
| Limited-access | Sensitive geocoded variables (approval required) |

Together, these files contain ~1,200 questions (i.e.features) collected from more than one million respondents.

## Feature Selection (Boruta)

Because NHANES is a general-purpose health survey, many variables are weak or irrelevant predictors of diabetes. Training on the full feature would require high computational costs and risk of overfitting. We therefore run a **Boruta** to identify the most informative features; the resulting whitelist is stored under `data/boruta_result.csv`.

## Model Tuning & Training

We adopt **XGBoost** for its strong performance on tabular data and native handling of missing values. Hyper-parameters are optimized with Bayesian optimization (Optuna) across stratified 5d-fold cross-validation. Final metrics and artifacts are logged to MLflow; run `./scripts/evaluate_model.sh` for details of the current champion model.


## License
All rights reserved ©Loretta Health. Redistribution or commercial use without explicit written permission is prohibited.